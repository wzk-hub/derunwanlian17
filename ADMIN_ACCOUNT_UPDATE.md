# 管理员账号更新说明

## 更新概述

本次更新将系统管理员账号从 `derunwanlian888` 更改为 `15931319952`，并确保该号码专门用作管理员账号，删除系统中其他使用该号码的账号数据。

## 更新内容

### 1. 管理员账号信息
- **手机号**: `15931319952`
- **密码**: `ljqwzk0103888` (保持不变)
- **角色**: `admin`
- **名称**: `系统管理员`
- **ID**: `admin-1`

### 2. 自动清理功能

系统启动时会自动执行以下清理操作：

#### 2.1 用户数据清理
- 删除其他使用 `15931319952` 的非管理员账号
- 保留管理员账号
- 如果管理员账号不存在，自动创建

#### 2.2 关联数据清理
- **任务数据**: 清理相关账号发布、审核、支付确认、取消等记录
- **聊天群组**: 清理相关账号的群组成员，如果群组成员少于2人则删除整个群组
- **消息数据**: 清理相关账号发送的消息
- **通知数据**: 清理相关账号的通知记录
- **支付记录**: 清理相关账号的支付记录
- **结算记录**: 清理相关账号的结算记录
- **用户会话**: 清理相关账号的会话数据
- **用户偏好**: 清理相关账号的偏好设置

### 3. 手动管理功能

在管理员设置页面 (`/admin/settings`) 新增了账号管理功能：

#### 3.1 状态检查
- 实时显示管理员账号状态
- 显示是否发现重复账号
- 显示管理员账号详细信息

#### 3.2 手动清理
- **清理重复账号**: 手动触发清理操作
- **重置管理员账号**: 强制重置管理员账号（需要确认）

## 技术实现

### 1. 核心清理工具

创建了专门的清理工具 `src/utils/adminAccountCleanup.ts`：

```typescript
// 主要清理函数
export function cleanupDuplicateAccounts(phone: string = '15931319952'): CleanupResult

// 验证管理员账号状态
export function validateAdminAccount(): ValidationResult

// 强制重置管理员账号
export function forceResetAdminAccount(): CleanupResult
```

### 2. 自动执行

在 `src/App.tsx` 中集成了自动清理逻辑：

```typescript
useEffect(() => {
  // 使用专门的清理工具
  const result = cleanupDuplicateAccounts('15931319952');
  
  if (result.success) {
    console.log('管理员账号清理完成:', result.message);
  } else {
    console.error('管理员账号清理失败:', result.message);
  }
  
  // 验证管理员账号状态
  const validation = validateAdminAccount();
  if (!validation.isValid) {
    console.warn('管理员账号状态异常:', validation.message);
  }
}, []);
```

### 3. 登录页面更新

在 `src/pages/Login.tsx` 中更新了管理员账号初始化逻辑：

```typescript
// 删除其他使用15931319952的账号
const filteredUsers = users.filter((u: any) => u.phone !== '15931319952');

if (!hasAdmin) {
  const adminUser: User = {
    id: 'admin-1',
    phone: '15931319952',
    password: 'ljqwzk0103888',
    role: 'admin',
    name: '系统管理员',
    createdAt: new Date()
  };
  
  filteredUsers.push(adminUser);
  localStorage.setItem('users', JSON.stringify(filteredUsers));
}
```

## 使用说明

### 1. 登录系统

使用以下信息登录管理员账号：
- **手机号**: `15931319952`
- **密码**: `ljqwzk0103888`

### 2. 检查账号状态

登录后访问 `/admin/settings` 页面，可以：
- 查看当前管理员账号状态
- 检查是否发现重复账号
- 手动执行清理操作

### 3. 手动清理

如果发现系统中有重复账号，可以：
1. 点击"清理重复账号"按钮
2. 系统会自动清理所有相关数据
3. 查看清理结果和统计信息

### 4. 重置账号

如果管理员账号出现问题，可以：
1. 点击"重置管理员账号"按钮
2. 确认操作（会删除所有现有管理员账号）
3. 系统会自动创建新的管理员账号

## 安全说明

### 1. 数据保护
- 清理操作只删除非管理员账号的相关数据
- 管理员账号的数据会被保留
- 所有清理操作都有日志记录

### 2. 操作确认
- 重置管理员账号需要用户确认
- 清理操作会显示详细的统计信息
- 操作结果会通过toast通知显示

### 3. 错误处理
- 所有操作都有完善的错误处理
- 如果清理失败，会显示详细的错误信息
- 系统会自动回滚失败的清理操作

## 注意事项

### 1. 首次使用
- 系统启动时会自动执行清理
- 如果发现重复账号，建议手动检查清理结果
- 确保管理员账号状态正常

### 2. 数据备份
- 建议在执行重要操作前备份数据
- 清理操作会永久删除相关数据
- 重置操作会删除所有管理员账号

### 3. 权限控制
- 只有管理员可以访问账号管理功能
- 清理和重置操作需要管理员权限
- 操作日志会记录执行者信息

## 故障排除

### 1. 登录失败
- 检查手机号和密码是否正确
- 确认管理员账号状态是否正常
- 查看控制台是否有错误信息

### 2. 清理失败
- 检查浏览器控制台错误信息
- 确认localStorage权限是否正常
- 尝试手动执行清理操作

### 3. 状态异常
- 访问设置页面查看详细状态
- 执行手动清理操作
- 如果问题持续，考虑重置管理员账号

## 更新日志

- **2024-01-XX**: 管理员账号从 `derunwanlian888` 更改为 `15931319952`
- **2024-01-XX**: 新增自动清理功能
- **2024-01-XX**: 新增手动管理功能
- **2024-01-XX**: 完善错误处理和日志记录

## 联系支持

如果在使用过程中遇到问题，请联系系统管理员或查看系统日志获取更多信息。